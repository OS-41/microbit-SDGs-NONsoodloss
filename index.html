<!DOCTYPE html>

<html>
    <head>
        <script src="//cdn.jsdelivr.net/npm/matter-js@0.18.0/build/matter.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/matter-wrap@0.2.0/build/matter-wrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    </head>
    <body>
        Bluetooth接続サンプル
        <input type="button" value="スタート" onclick="pushStart()" />
        <script>
            let charaA, charaB;
            let phisics_started = false;
            window.onload = ()=>{
                // 1, 物理エンジン本体のクラス
                const engine = Engine.create();
                // 2, 画面を描画するクラス
                const render = Render.create({
                    element: document.body,
                    engine: engine,
                    options: {
                        width: WIDTH, height: HEIGHT,
                        showAngleIndicator: true,
                        showCollisions: true,
                        showDebug: false,
                        showIds: true,
                        showVelocity: true,
                        hasBounds: true,
                        wireframes: true// Important!!
                    }
                });
                Render.run(render);
                phisics_started = true;
            }
            function pushStart(){
                console.log("pushStart");
                //microbit ボタンサービスのUUIDを直入れ
                let buttonUuid =  "E95D9882-251D-470A-A062-FA1922DFA9A8";
                let AButtonUuid = "E95DDA90-251D-470A-A062-FA1922DFA9A8";
                let BButtonUuid = "E95DDA91-251D-470A-A062-FA1922DFA9A8";
                //デバイスの取得
                navigator.bluetooth.requestDevice(
                    //デバイスにフィルターかけて、マイクロビットだけが見えるようにできる
                    //ようですが上手くいかなかったので、とりあえず全デバイスを許可
                    //{filters: [{services:[buttonUuid.toLowerCase()]}] }
                    {acceptAllDevices:true,optionalServices:[buttonUuid.toLowerCase()]}
                ).then(         //デバイス取得できたら
                    device => {
                        console.log('Connecting micro:bit');
                        return device.gatt.connect();
                    }
                ).then(         //接続できたら
                    server => {
                        console.log('Getting Service');
                        return server.getPrimaryService(buttonUuid.toLowerCase());
                    }
                ).then(         //サービスが取得できたら
                    service => {
                        console.log('Getting Characteristics');
                        //２つのcharacteristicsの取得を待つ
                        return Promise.all([
                            //characteristicsの取得（Aボタン用）
                            service.getCharacteristic(AButtonUuid.toLowerCase())
                            .then(chara => {
                                //停止できるようにグローバルに保持
                                charaA = chara;
                                //通知サービスを開始
                                chara.startNotifications();
                                //リスナー関数の設定
                                chara.addEventListener('characteristicvaluechanged',listenerButtonA);
                            }
                            ),
                            //characteristicsの取得（Bボタン用）
                            service.getCharacteristic(BButtonUuid.toLowerCase())
                            .then(chara => {
                                //停止できるようにグローバルに保持
                                charaB = chara;
                                //通知サービスを開始
                                chara.startNotifications();
                                //リスナー関数の設定
                                chara.addEventListener('characteristicvaluechanged',listenerButtonB);
                            }
                            )
                        ]);
                    }
                )
                .catch(
                    error => {
                        //途中でエラー発生したらエラー出力
                        console.log('sorry Error!');
                        console.log(error.code);
                        console.log(error.message);
                        console.log(error.name);
                    }
                )
            }


            //Aボタン用リスナ
            function listenerButtonA(event){
                movR = (1 <= event.target.value.getUint8(0));
            }
            //Bボタン用リスナ
            function listenerButtonB(event){
                movL = (1 <= event.target.value.getUint8(0));
            }



            //TODO:game stopping statement
            //通知停止
            function gameStop(){
                if( charaA ){
                    //通知の停止
                    charaA.stopNotifications().then(() => {
                        //リスナーの解放
                        charaA.removeEventListener('characteristicvaluechanged',listenerButtonA);
                        console.log("stop notification");
                    });
                }
                if( charaB ){
                    //通知の停止
                    charaB.stopNotifications().then(() => {
                        //リスナーの解放
                        charaB.removeEventListener('characteristicvaluechanged',listenerButtonB);
                        console.log("stop notification");
                    });
                }
            }
            //TODO:game stopping statement
        </script>
    </body>
</html>
